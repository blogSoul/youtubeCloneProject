# âœˆ #6.0~12 user authenticaton like a boss âœˆ

## âœˆ #6.0 âœˆ

authentication(ì¸ì¦)ì„ ìœ„í•´ì„œ passportë¼ëŠ” moduleì„ ì‚¬ìš©í•  ì˜ˆì •ìž…ë‹ˆë‹¤.
ì‚¬ìš©ìžê°€ requestë¥¼ ë³´ë‚´ë©´ cookieë¥¼ serverì— ë³´ëƒ…ë‹ˆë‹¤.
ìš°ë¦¬ëŠ” passport-local-mongooseë¥¼ ì‚¬ìš©í•  ì˜ˆì •ìž…ë‹ˆë‹¤.

## âœˆ #6.1 âœˆ

ë¸Œë¼ìš°ì € ìƒì— cookiesë¥¼ ì„¤ì •í•´ì£¼ë©´, ê·¸ ì¿ í‚¤ë¥¼ í†µí•´ì„œ ì‚¬ìš©ìž idë“¤ì„ ì•Œ ìˆ˜ ìžˆê³  passportê°€ browserì—ì„œ ìžë™ìœ¼ë¡œ cookieë¥¼ ê°€ì €ì™€ì„œ user objectë¥¼ controllerì— ë„˜ê²¨ì¤ë‹ˆë‹¤.  
passport-local-mongooseëŠ” íŒ¨ìŠ¤ì›Œë“œ ì„¤ì •, íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ ë“±ë“±ì„ ìžë™ìœ¼ë¡œ í•´ì£¼ëŠ” moduleìž…ë‹ˆë‹¤.
**npm i passport passport-local command:** npm i passport passport-local
**passport-local-mongoose install command :** npm install passport-local-mongoose  
avatarUrlì€ fileUrlê³¼ ê°™ì€ ì˜ë¯¸ë¥¼ ì§€ë‹™ë‹ˆë‹¤.
passport-localì´ëž€ usernameì™€ passwordë¥¼ ì“°ëŠ” ì‚¬ìš©ìž ì¸ì¦ ë°©ì‹(strategy)ìž…ë‹ˆë‹¤.  
passport-local install command : npm i passport passport-local
strategyëŠ” ë¡œê·¸ì¸í•˜ëŠ” ë°©ì‹ìž…ë‹ˆë‹¤.

## âœˆ #6.2 âœˆ

cookieì—ëŠ” ë¯¼ê°í•œ ì •ë³´ë¥¼ ë‹´ìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤.  
serializationì€ ì–´ë–¤ fieldê°€ ì¿ í‚¤ì— í¬í•¨ë  ê²ƒì¸ì§€ ì•Œë ¤ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.  
deserializationì€ "ì–´ëŠ ì‚¬ìš©ìžì¸ì§€ ì–´ë–»ê²Œ ì°¾ëŠ”ê°€?"

## âœˆ #6.3 âœˆ

`next()`ë¡œ ë‹¤ìŒ middlewareë¡œ ë„˜ê²¨ì¤ë‹ˆë‹¤.

Ex) `globalRouter.post(routes.join, postJoin, postLogin);`ì—ì„œ postJoinì— `next()`ë¡œ ë„˜ì–´ê°€ë¯€ë¡œ postLoginì´ ë°œíœ˜ë©ë‹ˆë‹¤.

ìš°ì„  express-sessionì„ ì„¤ì¹˜í•´ì¤ë‹ˆë‹¤.

`app.use(passport.initialize());`  
`app.use(passport.session());`

cookieê°€ middlewareë¥¼ íƒ€ê³  ì´ë™í•˜ë‹¤ê°€ `passport.initialize()`ë¥¼ ë³´ê³  passportê°€ ìžê¸° ìŠ¤ìŠ¤ë¡œ ì¿ í‚¤ë¥¼ ë“¤ì—¬ë‹¤ë´ì„œ, ê·¸ ì¿ í‚¤ ì •ë³´ì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìžë¥¼ ì°¾ì•„ì¤„ ê²ƒìž…ë‹ˆë‹¤.  
`passport.session()`ì€ cookieë¥¼ sessionì— ì €ìž¥í•´ì¤„ ê²ƒìž…ë‹ˆë‹¤.

ExpresëŠ” passportë¥¼ í†µí•´ì„œ, sessionì„ ì´ìš©í•˜ëŠ”ë°, sessionì´ ê°€ì§„ ì¿ í‚¤ë¥¼ ì´ìš©í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.  
ê·¸ë¦¬ê³  passportê°€ deserializeë¥¼ ì§„í–‰í•´ sessionì€ ì¿ í‚¤ë¥¼ í•´ë…í•©ë‹ˆë‹¤.  
ê·¸ë¦¬ê³  ê·¸ IDëŠ” passportë¡œ ë„˜ì–´ê°€ê²Œ ë©ë‹ˆë‹¤.

## âœˆ #6.5 âœˆ

install connect-mongo : connect-mongoë¥¼ ì‚¬ìš©í•´ì•¼ë§Œ í•©ë‹ˆë‹¤.

## âœˆ #6.6 âœˆ

Authorization callback URL : `http://localhost:4000/auth/github/callback`

ì°¸ê³  ì‚¬ì´íŠ¸ : [Go to passportjs Link](http://www.passportjs.org/)

## âœˆ #6.7 âœˆ

í˜¹ì‹œë¼ë„ "AuthorizationError: The redirect_uri MUST be a valid URL." ê°€ ëœ¨ì‹ ë‹¤ë©´ passport.jsì—ì„œ callbackURL â†’ redirect_uri ë¡œ ë°”ê¿”ë³´ì„¸ìš”.
redirect_uriì„ ì‚¬ìš©í•˜ë©´ `Template literals`ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.  
(í…œí”Œë¦¿ ë¦¬í„°ëŸ´ì€ ë‚´ìž¥ëœ í‘œí˜„ì‹ì„ í—ˆìš©í•˜ëŠ” ë¬¸ìžì—´ ë¦¬í„°ëŸ´ìž…ë‹ˆë‹¤. ì—¬ëŸ¬ ì¤„ë¡œ ì´ë¤„ì§„ ë¬¸ìžì—´ê³¼ ë¬¸ìž ë³´ê°„ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ì´ì „ ë²„ì „ì˜ ES2015ì‚¬ì–‘ ëª…ì„¸ì—ì„œëŠ” "template strings" (í…œí”Œë¦¿ ë¬¸ìžì—´) ë¼ê³  ë¶ˆë ¤ ì™”ìŠµë‹ˆë‹¤.)

ì•„ë‹ˆë©´ ex) callbackURL : `http://localhost:4000/${routes.githubCallBack}`  
ì´ê±¸ callbackURL: `http://localhost:4000/auth/github/callback`ì´ë ‡ê²Œ ê³ ì¹˜ë©´ ìž˜ë©ë‹ˆë‹¤.

## âœˆ #6.8 âœˆ

Error: Failed to serialize user into session ì—ëŸ¬ëŠ”  
passport.serializeUser((user, done) => done(null, user));  
passport.deserializeUser((user, done) => done(null, user));

## âœˆ #6.9 Recap âœˆ

- Authentication

local ë°©ì‹ :

usernameê³¼ passwordë¥¼ post ë°©ì‹ìœ¼ë¡œ ì „ë‹¬í•˜ê³ , mongooseê°€ ìžë™ìœ¼ë¡œ ì±„í¬í•´ì¤ë‹ˆë‹¤. ë§žìœ¼ë©´ passportì—ê²Œ "ë§žìŠµë‹ˆë‹¤" ë¼ê³  ì•Œë¦¬ê³ , ì¿ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

Github ë°©ì‹ :

ì‚¬ìš©ìžëŠ” ê¹ƒí—™ ì›¹ì‚¬ì´íŠ¸ë¡œ ì´ë™í•˜ê³  ê¶Œí•œ ìŠ¹ì¸ì„ í•©ë‹ˆë‹¤. ê·¸ ì´í›„, ê¹ƒí—™ ì›¹ì‚¬ì´íŠ¸ëŠ” ìš°ë¦¬ì—ê²Œ ê·¸ ì‚¬ìš©ìžì˜ ì •ë³´ë¥¼ ë³´ë‚´ì£¼ëŠ”ë° Authorization callback URLë¡œ ì˜µë‹ˆë‹¤.  
ì´í›„ passportëŠ” githubLoginCallback í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ê²ƒìž…ë‹ˆë‹¤.  
githubLoginCallbackì€ ëª¨ë“  ì •ë³´ë¥¼ ë°›ì„ ìˆ˜ ìžˆê³  returnì„ í•  ë•Œ, cb(=callback)í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ë§Œ í•©ë‹ˆë‹¤. returnì„ í•œ ê°’ì— userê°€ ì¡´ìž¬í•˜ë©´ ì¿ í‚¤ë¥¼ ë§Œë“¤ê³  ì¿ í‚¤ë¥¼ ì €ìž¥í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¸Œë¼ìš°ì €ì— ì¿ í‚¤ë¥¼ ì €ìž¥í•©ë‹ˆë‹¤.

```
-> github website (auth)
github website(auth) -> Authorization callback URL
githubLoginCallback (profile)
    => cb(null, user)

    cookie = makeCookie(user)
    savedCookie = saveCookie(cookie)
    sendCookie(savedCookie)
```

## Quiz content ðŸ˜‘

What is a Strategy in PassportJS : It's an authentication mechanism  
What is a Provider in PassportJS : It's an external website that will authenticate the user  
What is the name of the Strategy for username/password auth in Passport : "local"  
What is serialization in PassportJS : Is a function where we can decide what information the cookie will have  
What is deserialization in PassportJS : Is a function where we turn the cookie into an user object  
After deserialization, how does passport gives us the user object? : It puts it in 'req.user'  
What happens if we don't use a CookieStore : The cookies will not be persistent
